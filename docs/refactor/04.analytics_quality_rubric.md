# Analytics Quality Rubric

Scoring: 0 (broken), 1 (weak), 2 (acceptable), 3 (excellent).

## Correctness
- 3/3: counts and dedupe results match pre-refactor baselines for the same tenant/date range.
- 1/3: dedupe creates duplicate events or drops valid events.

## API contracts
- 3/3: DTO shapes and route payload expectations are unchanged.
- 1/3: client payload shape or route response changes without compatibility.

## Types
- 3/3: view types are constrained and validated end-to-end.
- 1/3: type widened to `string` or validation bypassed.

## Concurrency safety
- 3/3: single timer, no overlapping flushes, requeue on failure.
- 1/3: multiple timers or concurrent flushes cause duplicate sends.

## Readability
- 3/3: helpers are small, named by intent, and flow is easy to trace.
- 1/3: deeply nested logic or misleading names hide intent.

## Duplication
- 3/3: tenant/type filters are centralized (map or helper).
- 1/3: repeated `OR` and `where` blocks for every type.

## Testability
- 3/3: deterministic helpers that can be unit-tested with minimal setup.
- 1/3: side effects mixed with logic, hard to isolate.

## Definition of Done

- All invariants in `docs/refactor/03.analytics_reference_standard.md` are satisfied.
- DTOs and HTTP contracts remain stable.
- Concurrency behavior is unchanged or improved (single timer, no overlapping flush).
- Queries keep tenant scoping and idempotency rules intact.
- Any refactor includes before/after count comparisons for at least one tenant.
