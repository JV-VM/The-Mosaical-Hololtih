# Analytics Reference Standard

Purpose: this module is the golden sample for analytics refactors. Keep all invariants below intact.

## Invariants (must not change)

1) TrackViewDto payload shape and validation
- Required shape: `type` plus optional `storeId`/`productId`/`pageId` and optional `viewerId`.
- Type validation must restrict to STORE_VIEW/PRODUCT_VIEW/PAGE_VIEW.
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-view.dto.ts:3`
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-view.dto.ts:4`
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-view.dto.ts:7`
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-view.dto.ts:15`

2) TrackBatchDto payload shape
- `events` is an array of `TrackViewDto` with max size 50.
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-batch.dto.ts:5`
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-batch.dto.ts:7`
- Evidence: `mosaical-hololith-backend/src/analytics/dto/track-batch.dto.ts:10`

3) Validation of view types and required IDs
- Service must reject non-view types and missing IDs for the selected type.
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:59`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:62`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:65`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:68`

4) Idempotency behavior
- Idempotency key is based on `type`, `targetId`, `viewerHash`, and day.
- Only dedupe when both `viewerHash` and `targetId` exist; otherwise create a raw event.
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:139`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:182`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:184`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:194`

5) Frontend queue behavior (single timer + safe flush)
- Queue items are flat events with `viewerId`.
- Single timer scheduling with `scheduleFlush`; no parallel flushes (`isFlushing` guard).
- Requeue on failed batch send.
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:19`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:21`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:33`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:44`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:58`

## Structural patterns

- Controller delegates to service; no business logic in routes.
- Service is split into validation, idempotency, query helpers, and presentation methods.
- Frontend helper is a thin queue/scheduler with minimal side effects.
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:59`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:175`
- Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:33`

## Prohibited anti-patterns

- Async directly inside `setTimeout` or double scheduling delays.
  - Use `scheduleFlush` + `runFlush` pattern with a single timer.
  - Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:25`
  - Evidence: `mosaical-hololith-backend/src/analytics/analytics.ts:33`
- Duplicated `OR` blocks per type in queries.
  - Use `TENANT_WHERE_BY_TYPE` map to generate filters.
  - Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:47`
  - Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:241`
- Non-null assertions in idempotency flow.
  - Guard early and return raw event when missing inputs.
  - Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:182`
  - Evidence: `mosaical-hololith-backend/src/analytics/analytics.service.ts:184`

## Analytics PR checklist (max 10)

1) DTO shapes unchanged (`TrackViewDto`, `TrackBatchDto`).
2) Type validation still restricts to STORE_VIEW/PRODUCT_VIEW/PAGE_VIEW.
3) Required ID validation per type preserved.
4) Idempotency key format unchanged and only used when `viewerHash` + `targetId` exist.
5) Frontend queue remains flat with `viewerId` and a single timer.
6) `isFlushing` guard prevents parallel flushes.
7) Batch send requeues on failure.
8) Tenant filters are generated via `TENANT_WHERE_BY_TYPE` map.
9) `last7Days` still uses the last-week buckets flow.
10) No new non-null assertions in analytics service or queue.
